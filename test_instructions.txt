# Testing Mail Organizer with Ngrok and Microsoft Graph

Since the application uses **Microsoft Graph Webhooks** (Notifications), it needs a publicly accessible URL to receive events. We use **ngrok** to create a secure tunnel from the public internet to your local machine.

## Prerequisites

1.  **Ngrok Account**: You need a free account to use ngrok without connection limits.
    -   Sign up at [dashboard.ngrok.com/signup](https://dashboard.ngrok.com/signup).
2.  **Authtoken**: After signing up, get your Authtoken from [dashboard.ngrok.com/get-started/your-authtoken](https://dashboard.ngrok.com/get-started/your-authtoken).

## Step-by-Step Testing Guide

### 1. Configure Ngrok
The easiest way to authenticate ngrok is to add your token to the `.env` file. The application (via `pyngrok`) will automatically pick it up.

1.  Open your `.env` file.
2.  Add a new line:
    ```env
    NGROK_AUTHTOKEN=your_token_starts_with_2...
    ```
    *(Replace `your_token...` with the actual token copied from the ngrok dashboard)*

### 2. Start the Application
Run the main script. This will start the local server and the ngrok tunnel.

```bash
uv run main.py
```

**What to look for in the logs:**
-   `ngrok tunnel "https://<random-id>.ngrok-free.app" -> "http://localhost:8000"`: This confirms the tunnel is active.
-   `Subscription created successfully.`: This confirms Microsoft Graph accepted the URL.
-   `Authorized and subscribed! ID: ...`: The app is now listening.

### 3. Trigger a Test
1.  Open your email client and send an email **TO** the account you are monitoring (`TARGET_EMAIL`).
2.  **Subject**: "Test Marketing Email"
3.  **Body**: "This is a test email about a new promotion."
    *(Or perform a real test with a PHD inquiry or Social email)*

### 4. Verify Behavior
Watch the terminal window running `main.py`. Within 10-60 seconds (usually near instant), you should see:
1.  `Received webhook payload`: Microsoft notified your app.
2.  `Processing notification in background...`: The app started logic.
3.  `Processing email: Test Marketing Email`: It found the new email.
4.  `Analysis result`: The LLM output.
5.  `moved email ...`: If categorized, it moved.
6.  `Created task`: If actionable, a task was created.

### Troubleshooting
-   **413 Payload Too Large**: This means the email was too big for the LLM. We implemented truncation to fix this, but if it persists, the email might be exceptionally large.
-   **Ngrok Error**: If you see "The tunnel ... is already bound", make sure no other instance of the app is running.
-   **No Notification**: Check if the email actually arrived in the Inbox. If it went to Spam/Junk, Graph won't see it (we listen to Inbox).
